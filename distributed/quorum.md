# 简介
quorum 算法是分布式系统中常用的，用来保证数据冗余和最终一致性的投票算法，它的主要思想来源于鸽巢原理。

## 一致性问题
在相互独立的分布式节点中，在可控时间范围内达成一致决议的问题。

## 鸽巢原理
简单描述: n 个笼子和 n+1 只鸽子，所有鸽子都被关在笼子里，那么至少有一个笼子至少 2 只鸽子。
进一步描述: 有 n 个笼子和 kn+1 个鸽子，所有鸽子都被关在笼子里，那么至少有一个笼子有至少 k+1 只鸽子。
数学集合描述: 若 A 是 n+1 元集，B 是 n 元集，则不存在从 A 到 B 的单射线。

## Quorum 算法
Quorum 算法在有冗余数据的分布式存储系统中，冗余数据对象在不同机器之间存放多份拷贝。但是同一时刻一个数据对象的多份拷贝只能用于读或者写。算法可以保证一份数据对象的多份拷贝不会被超过两个访问对象读写。

### Quorum 原理
分布式系统中，每一份数据拷贝对象都被赋予一票。每一个读操作获得的票数必须大于最小读票数，每个写操作获得的票数必须大于最小写票数才能读或者写。如果系统有 V 票( V 份冗余拷贝)，那么最小读写票数(quorum)满足如下限制:
1. Vr + Vw > V
2. Vw > V/2

第一条规则保证数据无法同时读、写，第二条规则保证数据的写操作是串行化的。

### Quorum NWR 三要素
N(副本数)，又叫复制因子。N 表示集群中同一份数据有多少副本。
W(写一致性级别)，表示对于客户端的一次写操作，只有成功完成 W 个副本的更新，才算写成功。
R(读一致性级别)，表示对于客户端的一次写操作，需要读 R 个副本，然后最终返回最新的那份数据。

N、W、R 值不同组合会产生不同的一致性效果。主要是两种效果:
1. W + R > N 时，对于客户端来讲，整个系统能保证强一致性，一定能返回更新后的那份数据。
2. W + R <= N 时，对于客户端来讲，整个系统只能保证最终一致性，可能返回旧数据。

## 实践
zookeeper 有两种运行模式，Standalone 和 Quorum ，Standalone 只有一个 zk 节点。而 Quorum 模式一组 Zookeeper 服务器，状态会被复制到多个节点，并一同为客户端提供服务。


## 参考
1. [维基百科 - Quorum (分布式系统)](https://zh.wikipedia.org/wiki/Quorum_(%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F))
2. [维基百科 - 鸽巢原理](https://zh.wikipedia.org/wiki/%E9%B4%BF%E5%B7%A2%E5%8E%9F%E7%90%86)
3. [分布式一致性：Quorum NWR算法](http://mstacks.com/129/1395.html#content1395)