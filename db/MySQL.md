# 简介
关系型数据库，常用的关系型数据库是 MySQL.对于 MySQL 的一些基本原理、性能、优化等都是需要掌握的.

## 知识点
MySQL 的主要知识包括索引及其原理、索引优化、事务、锁、分布式一致性.

### 索引
索引能极大地提升 MySQL 的查询效率，是数据库的关键知识点.
- 聚蔟索引: innodb 使用聚簇索引，叶子节点上存放了整行的数据.相对于非聚簇索引，查询效率更高，不用二次回表查询.但是相对的插入新值等会较慢.
- 非聚蔟索引: MyISAM 使用的是非聚簇索引，叶子节点仅仅记录了索引及对应的数据位置，需要再一次 I/O 查到行数据.
- 覆盖索引: 指的索引的叶子节点已经包含了需要查询的数据，不用根据主键进行二次查询.设计 SQL 语句时尽量使用覆盖索引将更加高效.
- B+ 树: MySQL 的索引结构.由于 MySQL 的数据及索引存储于磁盘中，其主要的性能瓶颈在于磁盘 I/O. MySQL 使用 B+ 树将数据存储在叶子节点中，而每个非叶子节点可以存储更多的索引键，这样可以让索引 B+ 树的高度更短，也就可以以更少的磁盘 I/O 次数查找到指定数据.
- B 树: B 树即二叉搜索树，数据的查询效率是 log2(n).
- 索引优化: 索引优化可以提升查询效率，主要编写高效的 SQL 语句.如在 select、group by、order by、join 等操作列上使用索引，尽量使用批量插入数据等.
- LSM (Log-Structured Merge-Trees): 结构化合并树, 大多数 NoSQL 数据库的核心思想都是基于 LSM 树做的. 它不属于具体的数据结构, 更多的是一种数据结构的设计思想.

### ES 索引
MySQL 的索引并不适合海量数据的查询，难以应对海量数据下复杂的查询.ES(Elasticsearch)基于 Lucene 引擎构建的开源分布式搜索分析引擎，可以提供针对 PB 数据的实时查询，在全文检索、日志分析、监控分析等场景应用广泛.可以用 es 配合 mysql 在商品查询等场景中未用户提供高效检索服务.

Elasticsearch 使用**倒排索引**, 可以快速的通过 value 查询，然后查询最终数据.将 value 进行有效排列，通过二叉搜索树便可以快速查询到指定 value 数据.

### 事务
事务具有 ACID 特性.
可以按照使用场景的将 MySQL 事务的隔离级别分为 RU、RC、RR、S，它们分别在数据一致性和性能上有所区别.
锁是保证数据一致性的重要方法，MySQL 在数据一致性及性能平衡上有这些方法: MVCC 、乐观锁、悲观锁、行锁、表锁

### 分布式
在分布式系统中，基本涉及到 Paxos 算法思想处理一致性，工程实践上 Raft、Zab 等也应用很广泛.

### 连接池
连接池，是维护数据库连接的缓存，便于需要对数据库进行访问时可以重用连接，提升效率.
- MySQL 服务端连接数: 通常，MySQL 的最大连接数默认为 100 ，最大可以设置为 16384. 通过 "show variables  like  'max_connections'" 命令可以查看最大连接数.
- 客户端连接池: 在客户端进程启动后，通常连接 MySQL 数据库并维护一个可重用的连接池.通常会设置 MaxIdle 和 MaxConnection 两个参数.
   - MaxIdle: MaxIdle 是最大空闲连接数，当数据库连接超过最大空闲时间，最多维护的连接数，避免太多连接数占用 MySQL 服务端的连接数量.同时, 维护一定数量的空闲连接可以提升访问效率，减少建立连接的时间消耗.
   - MaxConnection: 连接池中最大允许的连接数，需要确保连接数具有限制，否则会占用 MySQL 服务端的连接数量，通常 MaxConnection 大于 MaxIdle.

## 高可用
主从: 基于 binlog 可以实现主从架构的模式，包括一主一从、一主多从等.
- 一主一从、一主多从: 通过将主节点的数据同步到一个或多个从节点上，确保在主节点故障等时，数据不会丢失，或者进行主备切换，能够快速恢复服务. 
- 多主多从: 大部分场景中，MySQL 是单主模式.而在一些对性能有要求的场景中，也会存在多主模式.业界常用的多主模式有 MGR ，是 MySQL 官方提供的插件特性.数据具有强一致性，服务高可用可自动故障转移，具有冲突检测机制，可以多个 Master 同时写.
- 主从切换: 主从切换将从节点切换为主节点，可以让主节点在故障不可用时，从节点提供服务，保证 MySQL 的高可用，这里可能存在数据不一致的风险.目前的主从切换一般是手动的进行的，也有日本开发的 MHA 方案，在 30 秒内完成故障切换操作.

主从同步模式有异步模式、半同步模式、全同步模式.
- 异步模式: slave 节点连接 master 时，主动从 master 处获取最新的 bin log 文件.
- 半同步模式: 接受到其中一台从节点的返回信息就会 commit.否则需要等待超时然后切换成异步模式再提交.这样会一定程度上降低性能，但能保证 binlog 至少传输到了一个从节点.
- 全同步模式: 主节点和从节点全部执行 commit 并确认才算成功.

### MGR 群组复制
MGR(MySQL Group Replication): MySQL 的群组复制，提供更好的冗余性、自动恢复以及写入扩展.群组复制可以通过群组内任意服务器对数据进行更新，而不是主从之分.群组添加了一个验证步骤，通过验证的事务才能进行提交，提交后群组内其它成员同样进行释放、提交.

MGR 实现了 Replicated Database State Machine 理论，通信的服务基于 **Paxos** 理论实现，为 MySQL 5.7 之后的版本提供同步复制(日志复制、数据释放异步).从而提供高可用的 MySQL 数据库服务，它能实现故障自动转移，分布式容错能力、支持多主更新的架构，自动重配置(加入/移除节点、崩溃等)并自动侦测和处理冲突.

### MySQL Innodb Cluster
MySQL Innodb Cluster 是一个高可用的 MySQL 框架，它通过以下组件组成:
- MySQL Group Replication: 提供 DB 的扩展、自动故障转移
- MySQL Router: 轻量级中间件，提供应用程序连接目标的故障转移
- MySQL Shell: 新的 MySQL 客户端，多种接口模式.可以设置群组复制及Router
- X DevAPI: 一个 API 通过 XProtocol 与服务器通信
- Admin API: 一个特殊的API通过 MySQL Shell 使用，可以用于对 Innodb Cluster 进行配置管理

## 性能
MySQL 的性能根据磁盘、内存、CPU 等配置不同会有所差异，一般写性能在 1000/s 级别，而读性能在 10000/s 级别.所以在方案设计中，要充分考虑到数据库的写入能力，如在订单、支付等的需求中，需要考虑削峰、一致性等.而在数据读取上，要避免慢 SQL 查询，同时在高并发场景中，要考虑缓存优化、分库分表等方式避免超过 DB 的读性能瓶颈.

## 扩容
MySQL 的扩容可以通过停服务扩容和平滑扩容方案.
- 停服务扩容: 应用服务需要中断，按照新的需求建立 db，数据迁移后恢复服务.
- 平滑扩容方案: 采用不中断应用服务的扩容方式，如主备同步后进行切换，数据双写等方式完成扩容.

扩容可以按照提升配置的方式分为垂直扩容和水平扩容，它们各有优缺点: 
- 垂直扩容: 主要是提高机器的配置，如 CPU、内存等.可以通过主备切换的方式完成扩容，选择好备机进行数据同步后，切换到备机.垂直扩容的主要缺点是依赖于单机的资源.
- 水平扩容: 水平扩容主要是解决垂直扩容依赖于单机的问题，理论上它是可以无限扩容的.但是水平扩容较为复杂，涉及数据搬迁、路由变化，并产生了分布式问题，同时为了处理这些问题性能也难以做到线性增长.
- TDSQL 水平扩容: 在水平扩容上，腾讯云的 TDSQL 采用了创建表时候进行分片，指定 shardkey 字段.这样在遇到瓶颈需要扩容的时候，可以已经分片的数据迁移到其它节点.这样扩容时，就不需要再进行数据拆分了.此外，在迁移过程中，TDSQL 也经历数据同步、数据校验、路由更新、冗余数据删除等操作，这几个操作会在一个较长的时间完成，但是不会影响应用服务.进行水平扩容后，分布式的 MySQL 集群中，还需要分布式事务解决原子性问题.另外，TDSQL 在性能上也进行了优化.

## 题目
1. MySQL innodb 的行级锁实现方式，如何避免表锁？
2. MySQL 的事务是如何实现的？(锁)
3. 数据库的三大范式?
4. MySQL 有关权限的表有哪几个?
5. 介绍事务的四大特性(ACID)?
6. 索引设计的原则是什么?
7. SQL 语句主要分为哪几类?
8. MySQL 分库分表的目的是什么?
9. 什么是死锁?怎么解决?
10. 什么是幻读?脏读?不可重复读?
11. 视图有哪些特点?

## 其它
密码存储方案: 直接存储、加密存储、hash 存储、hash + salt 存储、BCrypt 与 SCrypt 等算法.
- BCrypt 算法: BCrypt 是一个跨平台文件加密工具.它是一种单向加密算法，每次随机盐+明文进行加密，它会经过多次 hash 最终生成密文.最终的密文包含 salt 等信息，便于验证.
- SCrypt 算法: 是一种 KDF 算法, SCrypt 算法需要占用大量的内存，硬件要求高，从而提高了黑客试探的成本.

## 参考
1. [MySQL索引（二）B+树在磁盘中的存储](https://juejin.cn/post/6844903856388718606)
2. [亿级流量下平滑扩容：TDSQL水平扩容方案实践](https://cloud.tencent.com/developer/article/1611288)
3. [可能是我见过最好的 MySQL 高可用解决方案 MySQL InnoDB Cluster 中文教程！](https://www.modb.pro/db/15033)
4. [ElasticSearch 索引 VS MySQL 索引](https://segmentfault.com/a/1190000023733216)
5. [LSM树](https://fhfirehuo.github.io/Attacking-Java-Rookie/Chapter02/LSMTree.html)
6. [Sql Or NoSql，看完这一篇你就懂了](https://www.cnblogs.com/xrq730/p/11039384.html)