# 简介
Redis 是广泛使用的分布式缓存中间件. 可用于队列、分布式锁、Key-Value 数据库等. 

## 知识点
关于 Redis，需要掌握基本数据结构、跳表、Hash 冲突解决、持久化、主从、分布式、性能等知识.

### 持久化
redis 的持久化方式主要是 AOF、RDB .
AOF: 保存 binlog，将所有写入命令及参数写入文件保存在磁盘.
- AOF Rewrite 机制: 随着时间的推移，AOF 文件会膨胀的比较厉害，频繁的写入 AOF 文件将影响性能.系统通过 AOF Rewrite 机制定期重写 AOF 文件，将数据库的数据以协议方式保存到新的 AOF 文件中，重写的 AOF 小于原 AOF 文件，从而达到减小 AOF 文件目的.但是 AOF 也会占用较多的内存，写入 AOF buffer 过程中会阻塞工作线程.
- REWRITE: 主线程中重写 AOF，阻塞工作线程，生产环境中几乎不使用.
- BGREWRITE: 在后台子进程中重写 AOF，不阻塞工作线程.

RDB: 将 Redis 的当前数据以快照二进制的方式保存在磁盘，通过 RDB 的快照恢复数据更快.

### 主从
Redis 的高可用灾备方案主要是主从方式.
- 一主一从: 主要用于灾备、故障恢复、负载均衡等.将主节点 master 的数据单向的复制到从节点 slave 节点. 当主节点故障时，由从节点提供服务，另外也可以进行读写分离，从节点提供读服务，提高并发量.
- 多主多从: redis 的多主多从指的是 redis 的集群.每个主节点有一个或多个从节点，而集群的主节点之间通过分片操作，每个master节点存储一部分数据.
- 分片: 将数据拆分到多个 Redis 实例的过程，主要解决单机 Redis 容量有限的问题. 数据将按一定规则分配到多台机器. 采用多主多从, 没个分区一个主多个从.
- 哨兵: Redis 哨兵主要解决的是主从中出现宕机的情况，哨兵将监控 redis 的节点, 其中的一个主节点出现宕机故障时, 将自动将该 master 节点的某个 slave 节点升级为 master 节点，从而达到 redis 的高可用.

### 分片机制
Redis 通过一致性哈希解决分布式集群中，存在节点伸缩的情况下，有尽可能多的请求命中原来的机器节点.
- 分布式一致性哈希算法: 是一种特殊哈希算法, 使用一致性哈希算法后, 哈希表槽位数(大小)的改变平均只要对 K/n 个关键字重新映射, 其中 K 是关键字数量, n 是槽位数量. 使用一致性哈希可以用于分配分布式系统的服务器节点.
    - 容错性: 出现某个节点宕机后, 原数据将会保存到顺时针的下一个服务器节点, 其它节点数据不变.
    - 扩展性: 增加一个服务器节点, 将会使得其中一个节点的数据保存到另一个节点中. 影响的只有一小部分数据.
    - 数据倾斜问题: 节点少可能会造成分布不均衡的数据倾斜问题, 某些节点的 hash 范围大, 而某些节点 hash 范围少. redis 通过虚拟节点机制解决该问题.
    - 虚拟节点机制: 不改变数据定位的 hash 映射算法, 通过虚拟节点到实际节点的映射. 可以解决服务节点少时的数据不平均问题, 通常会将虚拟节点数设置为 32 甚至更多.
 
### 数据结构
redis 的数据结构包括 list、string、hash、set、zset 五种.它们的底层实现包括 ziplist、hashtable、intset、skiplist 等.
- ziplist: 压缩列表是为了节约内存而开发的，它主要用于 hash 和 list.由一系列特殊编码的内存块构成的列表，一个 ziplist 可以包含多个节点.
- skiplist: 是一种有序的数据结构.一个跳表有多个层 level 组成，通常是 10-20 层，默认是 12 层，每一层都是有序的链表，第 0 层拥有所有数据.它通过在每个节点中维持多个指向其它节点的指针，达到快速访问的目的.它的平均访问效率是 o(log n).

### 数据一致性
redis 无法满足数据的强一致性. 
- -**AOF 三个级别**: no 级别 AOF 文件同步由操作系统决定, everysec 每隔一秒执行一次文件同步, always 每次写入文件立即同步. always 十分消耗性能但也并不能满足数据强一致性, 它没有类似 MySQL 的二阶段提交保障写操作中崩溃导致的数据不一致性. 此外文件写入磁盘的过程并非原子操作, 而 MySQl 采用了 double write 解决写入磁盘的一致性.
- **主备**: redis 支持主备自动转移故障, 但主从互备也不能保障数据一致性. 当出现同时宕机、网络故障时影响主从同步、过期 key 不主动删除.
- **延时双删**: 是分布式系统中存储和缓存数据保持一致性的常用策略, 但它不是强一致性的. 通常有四个步骤, 删除 redis 缓存数据、更新数据库数据、逻辑延时执行、删除 redis 缓存数据.
-**分布式事务**: 保证不同服务器上数据库数据的一致性.
- **最终一致性**: 不保证在任意时刻任意节点上的同一份数据都是相同的, 但是随着时间的迁移, 不同节点上的同一份数据总是在向趋同的方向变化.
- **弱一致性**: 数据更新后，如果能容忍后续的访问只能访问到部分或者全部访问不到，则是弱一致性. 最终一致性属于弱一致性.
- **顺序一致性**: 用户在分布式系统的某个节点上进行了变更操作, 在一定时间后, 用户能从系统的任意节点上读取到变更结果. zookeeper 实现了 zab 协议, 通过两阶段提交达到数据的顺序一致性.
    - zab 协议两阶段提交一: 每次的数据写入事件作为提案广播给所有 Follower 结点, 可以写入的结点返回确认信息 ACK. 
    - zab 协议两阶段提交二: Leader 收到一半以上的 ACK 信息后确认写入可以生效, 向所有结点广播 COMMIT 将提案生效.
- **强一致性**: 也称为原子一致性、线性一致性, 满足两个要求.
    + 任何一次读都能读到某个数据的最近一次写的数据. 
    + 系统中的所有进程，看到的操作顺序，都和全局时钟下的顺序一致

### 实践
- 大 key: 通常以 key 的大小和 key 内成员数判定. 如 key 本身过大 string 类型 key 大小 5MB, key 成员数过多 zset 类型成员有 10000 个, key 成员的数据量过大 hash 类型的 key 的 value 总值大小 100MB.
    + 大 key 发现: 监控内存、流量、超时等. 大 key 由于很大，容易造成线程阻塞, 网络带宽上涨、客户端超时增加等性能问题. 亦可通过 bigkeys 命令、redis-rdb-tools 、可视化工具等发现.
    + 大 key 处理: 对非热 key 缓存可删除大 key, 对于不可删除的大 key 可选压缩或拆分大 key
- 热 key: 根据请求 key 的频次判定. 如 70% 的访问为特定的 key, 带宽使用率集中每秒对某个数据量 1MB 的 HASH key 发送大量 HGETALl, CPU 集中在特定的 key 每秒对有数万个成员的 zset key 发送大量 ZRANGE 请求.

## 性能
redis 的单机性能与机器配置有关，一般写性能在 10w qps 左右，读性能为 100w qps. 

## 问题
1. redis 的 zset 怎么实现的?(跳表、压缩表、哈希表)
2. 使用 zset 做排行榜时, 如果要实现分数相同时按时间排序怎么实现?
3. binlog 和 redolog 日志?
4. redis 大 key 如何删除避免崩溃?
5. redis 内存淘汰机制?
6. redis 分布式锁与 zookeeper 有什么区别?

## 参考
1. [Redis · 特性分析 · AOF Rewrite 分析](http://mysql.taobao.org/monthly/2016/03/05/)
2. [Redis数据结构底层实现](https://segmentfault.com/a/1190000040206818)
3. [redis中zSet排序原理----skipList跳跃表](https://segmentfault.com/a/1190000022320734)
4. [压缩列表](https://redisbook.readthedocs.io/en/latest/compress-datastruct/ziplist.html)
5. [Redis数据一致性分析](http://baobing.github.io/2017/12/23/Redis/Redis数据一致性分析/)
6. [延时双删（redis-mysql）数据一致性思考](https://zhuanlan.zhihu.com/p/467410359)
7. [别再说你不知道分布式事务了](https://www.51cto.com/article/711909.html)
8. [Abase2：字节跳动新一代高可用 NoSQL 数据库](https://www.51cto.com/article/709845.html)
9. [什么是顺序一致性？](https://zhuanlan.zhihu.com/p/527494829)
10. [发现并处理Redis的大Key和热Key](https://help.aliyun.com/document_detail/353223.html)
11. [解决了Redis大key问题，同事们都夸他牛皮](https://www.51cto.com/article/701990.html)
12. [5分钟理解一致性哈希算法](https://juejin.cn/post/6844903750860013576)